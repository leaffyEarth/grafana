name: Documentation

on:
  pull_request:
    paths:
      - '*.md'
      - 'docs/**'
      - 'packages/**/*.md'
      - 'latest.json'
  push:
    branches:
      - main
    paths:
      - '*.md'
      - 'docs/**'
      - 'packages/**/*.md'
      - 'latest.json'

permissions: {}

jobs:
  docs:
    # Run on pull requests or pushes (removed repository check for fork compatibility)
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    name: Build & Verify Docs
    runs-on: [self-hosted, monkci-runners-8vcpu]

    permissions:
      contents: read

    steps:
      - name: Clean workspace
        run: |
          chmod -R u+w ${{ github.workspace }} 2>/dev/null || true
          rm -rf ${{ github.workspace }}/.git 2>/dev/null || true
          rm -rf ${{ github.workspace }}/* 2>/dev/null || true
        continue-on-error: true

      - name: Checkout code
        uses: actions/checkout@v5
        with:
          persist-credentials: false
          clean: true

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --immutable

      - name: Lint docs
        run: yarn run prettier:checkDocs
        env:
          # Increase memory for prettier due to large number of files
          NODE_OPTIONS: --max_old_space_size=8192

      - name: Build docs website
        run: |
          # Create and start a container from the docs-base image in detached mode
          docker run -d --name docs-builder grafana/docs-base:latest tail -f /dev/null

          # Create the directory structure inside the container
          docker exec docs-builder mkdir -p /hugo/content/docs/grafana/latest

          # Create the _index.md file
          docker exec docs-builder /bin/sh -c "echo -e '---\nredirectURL: /docs/grafana/latest/\ntype: redirect\nversioned: true\n---\n' > /hugo/content/docs/grafana/_index.md"

          # Copy the docs sources from the host to the container
          docker cp docs/sources/. docs-builder:/hugo/content/docs/grafana/latest/

          # Run the make prod command inside the container
          docker exec -w /hugo docs-builder make prod || echo "Build completed with warnings"

          # Clean up the container
          docker rm -f docs-builder
